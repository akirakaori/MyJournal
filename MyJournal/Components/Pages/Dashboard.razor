@page "/dashboard"
@using MudBlazor

<MudStack Spacing="3" Style="padding:4px 6px 12px 6px;">
    <MudPaper Elevation="0" Rounded="true" Class="pa-4"
              Style="border:1px solid var(--mud-palette-divider); background:rgba(255,255,255,0.02);">
        <MudStack Row="true" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Style="gap:12px;">
            <MudStack Spacing="0">
                <MudText Typo="Typo.h3" Style="line-height:1.05; font-weight:750;">
                    Dashboard
                </MudText>
            </MudStack>

            <div style="position:relative;">
                <MudButton Variant="Variant.Outlined"
                           StartIcon="@Icons.Material.Filled.DateRange"
                           OnClick="TogglePicker"
                           Style="border-radius:12px; font-weight:650;">
                    @RangeLabel
                </MudButton>

                <MudPopover Open="_pickerOpen"
                            AnchorOrigin="Origin.BottomRight"
                            TransformOrigin="Origin.TopRight">
                    <MudPaper Class="pa-3" Elevation="8" Rounded="true" Style="min-width:360px; border-radius:14px;">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle1" Style="font-weight:700;">Select date range</MudText>

                            <MudDateRangePicker @bind-DateRange="_tempRange"
                                                Variant="Variant.Outlined"
                                                Margin="Margin.Dense"
                                                Editable="false"
                                                PickerVariant="PickerVariant.Inline"
                                                DateFormat="dd MMM yyyy"
                                                MaxDate="@DateTime.Today" />

                            <MudStack Row="true" JustifyContent="flex-end" Spacing="1">
                                <MudButton Variant="Variant.Text" OnClick="ClosePicker">Close</MudButton>
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ApplyRange" Style="border-radius:12px;">
                                    Apply
                                </MudButton>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                </MudPopover>
            </div>
        </MudStack>
    </MudPaper>

    <MudGrid Spacing="2">
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="1" Rounded="true" Style="border-radius:16px;">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.BarChart" />
                            <MudText Typo="Typo.h6" Style="font-weight:800;">Mood Distribution</MudText>
                        </MudStack>
                    </MudStack>

                    @if (_loading)
                    {
                        <MudProgressLinear Indeterminate="true" />
                    }
                    else if (_total == 0)
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                            No entries found in this date range.
                        </MudAlert>
                    }
                    else
                    {
                        <div style="height:250px; display:flex; align-items:flex-end; justify-content:center; gap:34px; padding:8px 6px 0 6px; overflow:hidden;">
                            @Bar("Positive", _positivePct, "var(--mud-palette-success)")
                            @Bar("Neutral", _neutralPct, "var(--mud-palette-info)")
                            @Bar("Negative", _negativePct, "var(--mud-palette-error)")
                        </div>

                        <div style="height:1px; width:100%; background:rgba(255,255,255,0.06); margin-top:10px;"></div>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="1" Rounded="true" Style="border-radius:16px; height:100%;">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.Star" />
                            <MudText Typo="Typo.h6" Style="font-weight:800;">Most Frequent Mood</MudText>
                        </MudStack>
                    </MudStack>

                    @if (_loading)
                    {
                        <MudProgressLinear Indeterminate="true" />
                    }
                    else if (_topMoods.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                            No mood data found.
                        </MudAlert>
                    }
                    else
                    {
                        <MudGrid Spacing="2">
                            <MudItem xs="12" sm="5">
                                <MudPaper Elevation="0" Rounded="true" Class="pa-3"
                                          Style="border-radius:14px; border:1px solid rgba(255,255,255,0.08); background:rgba(255,255,255,0.02);">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-weight:700;">Top mood</MudText>
                                    <MudText Typo="Typo.h5" Style="line-height:1.05; font-weight:850;">
                                        @_mostFrequentMood
                                    </MudText>
                                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Style="opacity:.9;">
                                        @_mostFrequentMoodCount of @_moodTotal (@_mostFrequentMoodPct%)
                                    </MudText>
                                </MudPaper>
                            </MudItem>

                            <MudItem xs="12" sm="7">
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-weight:700;">Top 5 moods</MudText>

                                <MudStack Spacing="1" Class="mt-1">
                                    @foreach (var m in _topMoods.Take(5))
                                    {
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudText Typo="Typo.body2"
                                                     Style="width:120px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:650;">
                                                @m.Name
                                            </MudText>

                                            <div style="flex:1; height:12px; border-radius:999px; background:rgba(255,255,255,0.08); overflow:hidden;">
                                                <div style="height:100%; width:@($"{m.Percent}%"); background:rgba(124,92,255,0.95); border-radius:999px;"></div>
                                            </div>

                                            <MudText Typo="Typo.body2" Style="width:44px; text-align:right; opacity:.9;">@m.Percent%</MudText>
                                        </MudStack>
                                    }
                                </MudStack>
                            </MudItem>
                        </MudGrid>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid Spacing="2">
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="1" Rounded="true" Style="border-radius:16px; height:100%;">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.DonutSmall" />
                            <MudText Typo="Typo.h6" Style="font-weight:800;">Tag Breakdown</MudText>
                        </MudStack>
                    </MudStack>

                    @if (_loading)
                    {
                        <MudProgressLinear Indeterminate="true" />
                    }
                    else if (_topTagsByEntries.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                            No tag data found.
                        </MudAlert>
                    }
                    else
                    {
                        <MudStack Spacing="2">
                            <MudStack Row="true" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-weight:700;">
                                    Percent of entries per category (Top 5)
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-weight:700;">
                                    Based on tagged entries
                                </MudText>
                            </MudStack>

                            <div style="width:100%; height:16px; border-radius:999px; overflow:hidden; display:flex; background:rgba(255,255,255,0.08);">
                                @{
                                    var i = 0;
                                }
                                @foreach (var t in _topTagsByEntries.Take(5))
                                {
                                    var c = SliceColor(i);
                                    <div title="@($"{t.Name} {t.Percent}%")"
                                         style="height:100%; width:@($"{t.Percent}%"); background:@c;">
                                    </div>
                                    i++;
                                }
                            </div>

                            <MudDivider Class="my-2" />

                            <MudStack Spacing="1">
                                @{
                                    var j = 0;
                                }
                                @foreach (var t in _topTagsByEntries.Take(5))
                                {
                                    var c = SliceColor(j);

                                    <MudStack Row="true" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                            <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:@c;"></span>
                                            <MudText Typo="Typo.body2" Style="font-weight:650;">@t.Name</MudText>
                                        </MudStack>
                                        <MudText Typo="Typo.body2" Style="opacity:.9;">@t.Percent%</MudText>
                                    </MudStack>

                                    j++;
                                }
                            </MudStack>
                        </MudStack>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="1" Rounded="true" Style="border-radius:16px;">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.LocalOffer" />
                            <MudText Typo="Typo.h6" Style="font-weight:800;">Most Used Tags</MudText>
                        </MudStack>
                    </MudStack>

                    @if (_loading)
                    {
                        <MudProgressLinear Indeterminate="true" />
                    }
                    else if (_topTags.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                            No tag data found.
                        </MudAlert>
                    }
                    else
                    {
                        <div class="pieWrap">
                            <MudChart ChartType="ChartType.Pie"
                                      InputData="@TopTagsPieData"
                                      InputLabels="@TopTagsPieLabels"
                                      Width="100%"
                                      Height="280px" />
                        </div>

                        <MudDivider Class="mt-2" />
                    }
                </MudStack>
            </MudPaper>
        </MudItem>

        @* ✅ NEW: last row full width *@
        <MudItem xs="12">
            <MudPaper Class="pa-4" Elevation="1" Rounded="true" Style="border-radius:16px;">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Style="gap:12px;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.ShowChart" />
                            <MudText Typo="Typo.h6" Style="font-weight:800;">
                                Word Count Trends
                                <span style="opacity:.75; font-weight:650;">→ Average words per entry (Jan–Dec)</span>
                            </MudText>
                        </MudStack>

                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudText Typo="Typo.body2" Style="opacity:.85; font-weight:650;">Year</MudText>

                            <MudSelect T="int"
                                       Dense="true"
                                       Variant="Variant.Outlined"
                                       Style="min-width:140px;"
                                       Value="_wcYear"
                                       ValueChanged="OnWordCountYearChanged">
                                @foreach (var y in _wcYears)
                                {
                                    <MudSelectItem Value="@y">@y</MudSelectItem>
                                }
                            </MudSelect>
                        </MudStack>
                    </MudStack>



                    @if (_wcLoading)
                    {
                        <MudProgressLinear Indeterminate="true" />
                    }
                    else
                    {
                        <MudChart ChartType="ChartType.Line"
                                  ChartSeries="_wcSeries"
                                  XAxisLabels="_wcLabels"
                                  Width="100%"
                                  Height="300px" />
                    }
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudStack>

@code {
    private RenderFragment Bar(string label, int pct, string colorVar) => @<div style="width:92px; display:flex; flex-direction:column; align-items:center;">
        <div style="height:210px; width:24px; display:flex; align-items:flex-end;">
            <div style="width:100%; height:@($"{pct * 2.1}px"); background:@colorVar; border-radius:999px;"></div>
        </div>
        <div style="margin-top:10px; text-align:center;">
            <div style="font-weight:800;">@pct%</div>
            <div style="opacity:.85; font-size:0.92rem;">@label</div>
        </div>
    </div>;
}


<style>
    .pieWrap {
        width: 100%;
        max-width: 360px;
        margin: 0 auto;
    }
</style>
