@page "/reset-password"
@using MudBlazor
@inject MyJournal.Services.AuthService AuthService
@inject MyJournal.Services.OTPService OTPService
@inject MyJournal.Services.EmailService EmailService
@inject NavigationManager NavigationManager

<MudGrid Justify="Justify.Center" Style="min-height: 100vh;" AlignItems="AlignItems.Center">
    <MudItem xs="12" sm="6" md="4">
        <MudPaper Class="pa-6" Elevation="6">

            <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-4">
                Reset Your PIN
            </MudText>

            <MudText Typo="Typo.body2" Align="Align.Center" Class="mb-6" Color="Color.Default">
                Enter the code sent to your email and your new PIN
            </MudText>

            <MudForm @ref="_form" Spacing="4">

                <MudTextField T="string"
                              Label="6-Digit Code"
                              @bind-Value="_otp"
                              Required="true"
                              RequiredError="Reset code is required"
                              MaxLength="6"
                              HelperText="Enter the 6-digit code from your email" />

                <MudTextField T="string"
                              Label="New 4-Digit PIN"
                              @bind-Value="_newPin"
                              InputType="@_pinInputType"
                              Required="true"
                              RequiredError="New PIN is required"
                              Validation="@(new Func<string, string?>(ValidatePin))"
                              MaxLength="4"
                              Adornment="Adornment.End"
                              AdornmentIcon="@_pinVisibilityIcon"
                              OnAdornmentClick="TogglePinVisibility" />

                <MudTextField T="string"
                              Label="Confirm New PIN"
                              @bind-Value="_confirmPin"
                              InputType="@_confirmPinInputType"
                              Required="true"
                              RequiredError="Please confirm your PIN"
                              Validation="@(new Func<string, string?>(ValidateConfirmPin))"
                              MaxLength="4"
                              Adornment="Adornment.End"
                              AdornmentIcon="@_confirmPinVisibilityIcon"
                              OnAdornmentClick="ToggleConfirmPinVisibility" />

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth="true"
                           Class="mt-4"
                           Disabled="@_isBusy"
                           OnClick="HandleResetPassword">
                    @if (_isBusy)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ml-2">Resetting...</MudText>
                    }
                    else
                    {
                        <span>Reset PIN</span>
                    }
                </MudButton>

                <MudButton Variant="Variant.Outlined"
                           Color="Color.Secondary"
                           FullWidth="true"
                           Class="mt-2"
                           Disabled="@_isBusy"
                           OnClick="HandleResendOTP">
                    Resend Code
                </MudButton>

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mt-4">
                        @_errorMessage
                    </MudAlert>
                }

                @if (!string.IsNullOrEmpty(_successMessage))
                {
                    <MudAlert Severity="Severity.Success" Variant="Variant.Filled" Class="mt-4">
                        @_successMessage
                    </MudAlert>
                }

                <MudButton Variant="Variant.Text"
                           Color="Color.Primary"
                           FullWidth="true"
                           Class="mt-2"
                           OnClick="@OnBackToLoginClicked">
                    Back to Login
                </MudButton>

            </MudForm>

        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private void OnBackToLoginClicked()
    {
        NavigationManager.NavigateTo("/login");
    }
}
