@page "/first-time-setup"
@using MudBlazor
@inject MyJournal.Services.AuthService AuthService
@inject NavigationManager NavManager

<div class="register-page">
    <div class="register-card">
        
        <!-- App Icon & Title -->
        <div class="app-header">
            <div class="app-icon">
                <MudIcon Icon="@Icons.Material.Filled.Book" Size="Size.Medium" Color="Color.Primary" />
            </div>
            <MudText Typo="Typo.subtitle1" Class="app-title">My Journal</MudText>
        </div>

        <!-- Welcome Heading -->
        <MudText Typo="Typo.h4" Class="welcome-heading">Welcome to MyJournal</MudText>
        <MudText Typo="Typo.body2" Class="subtitle-text">Let's set up your account</MudText>

        <MudForm @ref="_form" Class="register-form">

            <!-- Username Input -->
            <div class="input-group">
                <label class="input-label">Username</label>
                <MudTextField T="string"
                              @bind-Value="_username"
                              Required="true"
                              RequiredError="Username is required"
                              Variant="Variant.Outlined"
                              Class="custom-input"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Person" />
            </div>

            <!-- Email Input -->
            <div class="input-group">
                <label class="input-label">Email</label>
                <MudTextField T="string"
                              @bind-Value="_email"
                              InputType="InputType.Email"
                              Required="true"
                              RequiredError="Email is required"
                              Validation="@(new Func<string, string?>(ValidateEmail))"
                              Variant="Variant.Outlined"
                              Class="custom-input"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Email" />
            </div>

            <!-- PIN Input with Toggle Visibility -->
            <div class="input-group">
                <label class="input-label">4-Digit PIN</label>
                <MudTextField T="string"
                              @bind-Value="_pin"
                              InputType="@_pinInputType"
                              Required="true"
                              RequiredError="PIN is required"
                              Validation="@(new Func<string, string?>(ValidatePin))"
                              HelperText="Enter a 4-digit PIN for login"
                              MaxLength="4"
                              Variant="Variant.Outlined"
                              Class="custom-input"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Lock">
                    <end>
                        <MudIconButton Icon="@_pinVisibilityIcon" 
                                       OnClick="TogglePinVisibility" 
                                       Edge="Edge.End"
                                       Size="Size.Small"
                                       aria-label="Toggle PIN visibility" />
                    </end>
                </MudTextField>
            </div>

            <!-- Confirm PIN Input with Toggle Visibility -->
            <div class="input-group">
                <label class="input-label">Confirm PIN</label>
                <MudTextField T="string"
                              @bind-Value="_confirmPin"
                              InputType="@_confirmPinInputType"
                              Required="true"
                              RequiredError="Please confirm your PIN"
                              Validation="@(new Func<string, string?>(ValidateConfirmPin))"
                              MaxLength="4"
                              Variant="Variant.Outlined"
                              Class="custom-input"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Lock">
                    <end>
                        <MudIconButton Icon="@_confirmPinVisibilityIcon" 
                                       OnClick="ToggleConfirmPinVisibility" 
                                       Edge="Edge.End"
                                       Size="Size.Small"
                                       aria-label="Toggle confirm PIN visibility" />
                    </end>
                </MudTextField>
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="error-alert" Dense="true">
                    @_errorMessage
                </MudAlert>
            }

            <!-- Create Account Button -->
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       Class="register-button"
                       Disabled="@_isBusy"
                       OnClick="HandleSetup">
                @if (_isBusy)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <span style="margin-left: 8px;">Creating Account...</span>
                }
                else
                {
                    <text>Create Account</text>
                }
            </MudButton>

        </MudForm>

    </div>
</div>

<style>
    .register-page {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: var(--mud-palette-background);
        padding: 20px;
    }

    .register-card {
        background: var(--mud-palette-surface);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        padding: 40px 32px;
        width: 100%;
        max-width: 420px;
    }

    .app-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 24px;
    }

    .app-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--mud-palette-primary);
        border-radius: 8px;
        padding: 4px;
    }

    .app-icon .mud-icon-root {
        color: white !important;
    }

    .app-title {
        color: var(--mud-palette-primary);
        font-weight: 500;
        margin: 0;
    }

    .welcome-heading {
        text-align: center;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--mud-palette-text-primary);
    }

    .subtitle-text {
        text-align: center;
        margin-bottom: 28px;
        color: var(--mud-palette-text-secondary);
    }

    .register-form {
        display: flex;
        flex-direction: column;
        gap: 18px;
    }

    .input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .input-label {
        font-size: 14px;
        font-weight: 500;
        color: var(--mud-palette-text-primary);
        margin-bottom: 4px;
    }

    .custom-input {
        width: 100%;
    }

    .custom-input .mud-input-outlined {
        border-radius: 8px;
    }

    .custom-input .mud-input-root {
        padding: 12px 14px;
    }

    .error-alert {
        margin-top: 4px;
        border-radius: 8px;
    }

    .register-button {
        margin-top: 8px;
        padding: 14px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 16px;
        text-transform: none;
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.24);
        transition: all 0.2s ease;
    }

    .register-button:hover:not(:disabled) {
        box-shadow: 0 6px 16px rgba(33, 150, 243, 0.32);
        transform: translateY(-1px);
    }

    .register-button:active:not(:disabled) {
        transform: translateY(0);
    }

    /* Dark mode enhancements */
    @media (prefers-color-scheme: dark) {
        .register-card {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
        .register-card {
            padding: 32px 24px;
        }

        .welcome-heading {
            font-size: 1.75rem;
        }
    }
</style>
